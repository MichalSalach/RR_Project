---
title: "Reproducible Research 2021: Live analysis of betting odds for tennis matches"
author:
- "Rafał Rysiejko"
- "Michał Sałach"
date: "May 2021"
output:
 prettydoc::html_pretty:
   theme: cayman
params:
 money:
   label: "Money to bet"
   value: 1000
   min: 1
 expected_return:
   label: "Expected return, if the favourite wins (fraction of money to bet)"
   value: 0.1
   min: 0.01
 adverse_return:
   label: "Accepted return, if the favourite will not win (fraction of money to bet)"
   value: -0.2
   min: -1
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r pressure, echo=FALSE,include=FALSE}
library(tidyverse)  # tidyverse 1.3.1

# Note: I use the function if_any() from dplyr 1.0.5, which was not included in some of the 
# earlier versions of the package.

#### Data ####

data <- read_csv('../data_060521_163644.csv')

money <- params$money
expected_return <- params$expected_return
adverse_return <- params$adverse_return

##

# A list of bookmakers
bookmakers <- c('eFortuna', 'STS', 'Betclic', 'Betfan', 'Pzbuk', 'Lvbet', 'Totolotek')

bookmakers_links <- c('https://www.efortuna.pl/',
                      'https://www.sts.pl/',
                      'https://www.betclic.pl/',
                      'https://betfan.pl/zaklady-bukmacherskie',
                      'https://www.pzbuk.pl/pl',
                      'https://lvbet.pl/pl/',
                      'https://www.totolotek.pl/pl')

bookmakers_df <- data.frame(bookmakers,bookmakers_links)

# Add a match identifier and a boolean for whether a match is ongoing, or future (it's the case
# when there is no data for games).
# Then transform data to long format (match-bookmaker-value in separate columns) and count max
# and min offers for both players in a match.

data <- data %>%
  mutate(match_id = row_number(), .before = event) %>%
  mutate(match_current = if_else(if_any(contains('_games'), function(x)
    is.na(x)),
    0, 1), .after = match_time) %>%
  pivot_longer(cols = (paste0('player_1_', bookmakers)),
               names_to = 'player_1_bookmaker',
               values_to = 'player_1_odds') %>%
  pivot_longer(cols = (paste0('player_2_', bookmakers)),
               names_to = 'player_2_bookmaker',
               values_to = 'player_2_odds') %>%
  mutate(
    player_1_bookmaker = str_replace(player_1_bookmaker, 'player_1_', ''),
    player_2_bookmaker = str_replace(player_2_bookmaker, 'player_2_', '')
  ) %>%
  group_by(match_id) %>%
  mutate(
    player_1_odds_max = max(player_1_odds, na.rm = TRUE),
    player_1_odds_min = min(player_1_odds, na.rm = TRUE),
    player_2_odds_max = max(player_2_odds, na.rm = TRUE),
    player_2_odds_min = min(player_2_odds, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!(if_any(contains('_odds_'), function(x)
    is.infinite(x))))  # See the note below.

# Note: warnings signify that there are matches for which there is no offer (NAs for all
# bookmakers). It may happen that a future match has currently no betting odds, or that all 
# are crossed out by the bookmakers. We are not worried by that. The values of 
# `player_1_odds_max`, `player_1_odds_max`, `player_1_odds_max` and `player_1_odds_max` will be 
# then Inf/-Inf, and we filter them out.

# ---

#+ r min_adverse, include = FALSE

# Given the expected return ((1+expected_return)*money in the case when the favourite wins),
# count the adverse return (when the favourite loses). Filter out offers when potential loss
# exceeds the adverse return and sort descending.
# (Favourite is the player whose win guarantees expected return.)

data_min_adverse <- data %>%
  group_by(match_id) %>%
  mutate(to_bet_1_if_1_favourite = (1+expected_return)*money/player_1_odds_max,
         to_bet_2_if_1_favourite = money-to_bet_1_if_1_favourite,
         win_2_bet_1 = to_bet_2_if_1_favourite*player_2_odds_max,
         win_2_bet_1_return = (win_2_bet_1-money)/money,
         to_bet_2_if_2_favourite = (1+expected_return)*money/player_2_odds_max,
         to_bet_1_if_2_favourite = money-to_bet_2_if_2_favourite,
         win_1_bet_2 = to_bet_1_if_2_favourite*player_1_odds_max,
         win_1_bet_2_return = (win_1_bet_2-money)/money,
         better_adverse_return = max(win_2_bet_1_return, win_1_bet_2_return)) %>%
  ungroup() %>% 
  filter(player_1_odds == player_1_odds_max,
         player_2_odds == player_2_odds_max,
         better_adverse_return >= adverse_return,
         to_bet_1_if_1_favourite <= money,
         to_bet_1_if_2_favourite >= 0,
         to_bet_2_if_2_favourite <= money,
         to_bet_2_if_1_favourite >= 0) %>%
  mutate(better_favourite = if_else(win_1_bet_2 > win_2_bet_1, '2', '1'),
         better_non_favourite = if_else(better_favourite == '1', '2', '1')) %>% 
  arrange(desc(better_adverse_return))


book <- pull(data_max_return[paste0('player_', data_max_return$better_non_favourite[1], '_bookmaker')])[1]
link <- bookmakers_df %>% filter(bookmakers==pull(data_min_adverse[paste0('player_', data_min_adverse$better_non_favourite[1], '_bookmaker')])[1]) %>% select(bookmakers_links)


bookmakers_df %>% filter(bookmakers==pull(data_min_adverse[paste0('player_', data_min_adverse$better_non_favourite[1], '_bookmaker')])[1]) %>% select(bookmakers_links)

```

```{r variables, echo=FALSE,include=FALSE}
# List of variable for inline referencing

#==============================================
# Best bet summary
#==============================================

value_to_bet <- round(pull(data_min_adverse[paste0('to_bet_', data_min_adverse$better_favourite[1], '_if_', data_min_adverse$better_favourite[1], '_favourite')])[1], 2)

player_to_bet_for <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_favourite[1])])[1]
player_to_bet_for_nationality <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_favourite[1], '_nationality')])[1]
player_to_bet_for_atp_ranking <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_favourite[1], '_rank')])[1]
best_bet_bookmaker <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_favourite[1], '_bookmaker')])[1]
best_bet_bookmaker_link <- bookmakers_df %>% filter(bookmakers==pull(data_min_adverse[paste0('player_', data_min_adverse$better_favourite[1], '_bookmaker')])[1]) %>% select(bookmakers_links)
best_bet_betting_odds <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_favourite[1], '_odds')])[1]

value_to_bet2 <- round(pull(data_min_adverse[paste0('to_bet_', data_min_adverse$better_non_favourite[1], '_if_', data_min_adverse$better_favourite[1], '_favourite')])[1], 2)
player_to_bet_for2 <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_non_favourite[1])])[1]
player_to_bet_for_nationality2 <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_non_favourite[1], '_nationality')])[1] 
player_to_bet_for_atp_ranking2 <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_non_favourite[1], '_rank')])[1]
best_bet_bookmaker2 <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_non_favourite[1], '_bookmaker')])[1]
best_bet_bookmaker_link2 <- bookmakers_df %>% filter(bookmakers==pull(data_min_adverse[paste0('player_', data_min_adverse$better_non_favourite[1], '_bookmaker')])[1]) %>% select(bookmakers_links)
best_bet_betting_odds2 <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_non_favourite[1], '_odds')])[1]

expected_return_pln <- round(pull(data_min_adverse[paste0('win_', data_min_adverse$better_non_favourite[1], '_bet_', data_min_adverse$better_favourite[1])])[1], 2)
expected_return_percentage <- round(100*pull(data_min_adverse[paste0('win_', data_min_adverse$better_non_favourite[1], '_bet_', data_min_adverse$better_favourite[1], '_return')])[1], 2)

event <- pull(data_min_adverse['event'])[1]
match_time <- pull(data_min_adverse['match_time'])[1]

#==============================================
# List of best bets for each bookmaker
#==============================================

```


## Best bet prediction

Having `r money` PLN, the best bet to do right now in order to have `r 100*expected_return`% return in the case of a favorite win and minimal loss in the case of the favorite loss is to bet `r value_to_bet` PLN on `r player_to_bet_for` (`r player_to_bet_for_nationality`, ATP ranking: `r player_to_bet_for_atp_ranking`) on [`r best_bet_bookmaker`](`r best_bet_bookmaker_link`) (betting odds: `r best_bet_betting_odds`) and `r value_to_bet2` PLN on `r player_to_bet_for2` (`r player_to_bet_for_nationality2`, ATP ranking: `r player_to_bet_for_atp_ranking2`) on [`r best_bet_bookmaker2`](`r best_bet_bookmaker_link2`) (betting odds: `r best_bet_betting_odds2`, expected return: `r expected_return_pln` PLN, that is `r expected_return_percentage`%) in `r event` (starting `r match_time`).

**Disclaimer**

*Please note, that online betting is a gambling entertainment vehicle, and that it carries with it a certain degree of financial risk. Players should be aware of this risk, and govern themselves accordingly.*
