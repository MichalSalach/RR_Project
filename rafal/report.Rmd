---
title: "Reproducible Research 2021: Live analysis of betting odds for tennis matches"
author:
- "Rafał Rysiejko"
- "Michał Sałach"
date: "May 2021"
output:
 prettydoc::html_pretty:
   theme: cayman
params:
 money:
   label: "Money to bet"
   value: 1000
   min: 1
 expected_return:
   label: "Expected return, if the favourite wins (fraction of money to bet)"
   value: 0.1
   min: 0.01
 adverse_return:
   label: "Accepted return, if the favourite will not win (fraction of money to bet)"
   value: -0.2
   min: -1
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r pressure, echo=FALSE,include=FALSE}
library(tidyverse)  # tidyverse 1.3.1

# Note: I use the function if_any() from dplyr 1.0.5, which was not included in some of the 
# earlier versions of the package.

#### Data ####
data <- read_csv('../data_060521_163644.csv')

# A list of bookmakers
bookmakers <- c('eFortuna', 'STS', 'Betclic', 'Betfan', 'Pzbuk', 'Lvbet', 'Totolotek')

bookmakers_links <- c('https://www.efortuna.pl/',
                      'https://www.sts.pl/',
                      'https://www.betclic.pl/',
                      'https://betfan.pl/zaklady-bukmacherskie',
                      'https://www.pzbuk.pl/pl',
                      'https://lvbet.pl/pl/',
                      'https://www.totolotek.pl/pl')

bookmakers_df <- data.frame(bookmakers,bookmakers_links)

# Add a match identifier and a boolean for whether a match is ongoing, or future (it's the case
# when there is no data for games).
# Then transform data to long format (match-bookmaker-value in separate columns) and count max
# and min offers for both players in a match.

# Translate Polish tennis specific terms and countries name to English
dict <- read_csv('translation-20210524.csv') #Change working directory to main
for (i in 1:length(dict$pl)) {
  
  data$event <- as.data.frame(sapply(data$event,gsub,pattern=dict[i,]$pl,replacement=dict[i,]$angl))

}


data <- as.data.frame(do.call(cbind, data)) %>% rename(event=`sapply(data$event, gsub, pattern = dict[i, ]$pl, replacement = dict[i, ]$angl)`)

data <- data %>%
  mutate(match_id = row_number(), .before = event) %>%
  mutate(match_current = if_else(if_any(contains('_games'), function(x)
    is.na(x)),
    0, 1), .after = match_time) %>%
  pivot_longer(cols = (paste0('player_1_', bookmakers)),
               names_to = 'player_1_bookmaker',
               values_to = 'player_1_odds') %>%
  pivot_longer(cols = (paste0('player_2_', bookmakers)),
               names_to = 'player_2_bookmaker',
               values_to = 'player_2_odds') %>%
  mutate(
    player_1_bookmaker = str_replace(player_1_bookmaker, 'player_1_', ''),
    player_2_bookmaker = str_replace(player_2_bookmaker, 'player_2_', '')
  ) %>%
  group_by(match_id) %>%
  mutate(
    player_1_odds_max = max(player_1_odds, na.rm = TRUE),
    player_1_odds_min = min(player_1_odds, na.rm = TRUE),
    player_2_odds_max = max(player_2_odds, na.rm = TRUE),
    player_2_odds_min = min(player_2_odds, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(!(if_any(contains('_odds_'), function(x)
    is.infinite(x))))  # See the note below.

# Note: warnings signify that there are matches for which there is no offer (NAs for all
# bookmakers). It may happen that a future match has currently no betting odds, or that all 
# are crossed out by the bookmakers. We are not worried by that. The values of 
# `player_1_odds_max`, `player_1_odds_max`, `player_1_odds_max` and `player_1_odds_max` will be 
# then Inf/-Inf, and we filter them out.


# Given the expected return ((1+expected_return)*money in the case when the favourite wins),
# count the adverse return (when the favourite loses). Filter out offers when potential loss
# exceeds the adverse return and sort descending.
# (Favourite is the player whose win guarantees expected return.)

data_min_adverse <- data %>%
  group_by(match_id) %>%
  mutate(to_bet_1_if_1_favourite = (1+expected_return)*money/player_1_odds_max,
         to_bet_2_if_1_favourite = money-to_bet_1_if_1_favourite,
         win_2_bet_1 = to_bet_2_if_1_favourite*player_2_odds_max,
         win_2_bet_1_return = (win_2_bet_1-money)/money,
         to_bet_2_if_2_favourite = (1+expected_return)*money/player_2_odds_max,
         to_bet_1_if_2_favourite = money-to_bet_2_if_2_favourite,
         win_1_bet_2 = to_bet_1_if_2_favourite*player_1_odds_max,
         win_1_bet_2_return = (win_1_bet_2-money)/money,
         better_adverse_return = max(win_2_bet_1_return, win_1_bet_2_return)) %>%
  ungroup() %>% 
  filter(player_1_odds == player_1_odds_max,
         player_2_odds == player_2_odds_max,
         better_adverse_return >= adverse_return,
         to_bet_1_if_1_favourite <= money,
         to_bet_1_if_2_favourite >= 0,
         to_bet_2_if_2_favourite <= money,
         to_bet_2_if_1_favourite >= 0) %>%
  mutate(better_favourite = if_else(win_1_bet_2 > win_2_bet_1, '2', '1'),
         better_non_favourite = if_else(better_favourite == '1', '2', '1')) %>% 
  arrange(desc(better_adverse_return))


data_max_return <- data %>%
  group_by(match_id) %>%
  mutate(to_bet_1_if_2_favourite = (1+adverse_return)*money/player_1_odds_max,
         to_bet_2_if_2_favourite = money-to_bet_1_if_2_favourite,
         to_bet_2_if_1_favourite = (1+adverse_return)*money/player_2_odds_max,         
         to_bet_1_if_1_favourite = money-to_bet_2_if_1_favourite,
         win_1_bet_1 = to_bet_1_if_1_favourite*player_1_odds_max,
         win_1_bet_1_return = (win_1_bet_1-money)/money,
         win_2_bet_2 = to_bet_2_if_2_favourite*player_2_odds_max,
         win_2_bet_2_return = (win_2_bet_2-money)/money,
         better_return = max(win_1_bet_1_return, win_2_bet_2_return)) %>% 
  ungroup() %>% 
  filter(player_1_odds == player_1_odds_max,
         player_2_odds == player_2_odds_max,
         better_return >= expected_return,
         to_bet_1_if_1_favourite <= money,
         to_bet_1_if_2_favourite >= 0,
         to_bet_2_if_2_favourite <= money,
         to_bet_2_if_1_favourite >= 0) %>%
  mutate(better_favourite = if_else(win_2_bet_2 > win_1_bet_1, '2', '1'),
         better_non_favourite = if_else(better_favourite == '1', '2', '1')) %>% 
  arrange(desc(better_return))



book <- pull(data_max_return[paste0('player_', data_max_return$better_non_favourite[1], '_bookmaker')])[1]
link <- bookmakers_df %>% filter(bookmakers==pull(data_min_adverse[paste0('player_', data_min_adverse$better_non_favourite[1], '_bookmaker')])[1]) %>% select(bookmakers_links)


bookmakers_df %>% filter(bookmakers==pull(data_min_adverse[paste0('player_', data_min_adverse$better_non_favourite[1], '_bookmaker')])[1]) %>% select(bookmakers_links)

```

```{r variables, echo=FALSE,include=FALSE}
# List of variable for inline referencing

#==============================================
# Best bet summary
#==============================================

value_to_bet <- round(pull(data_min_adverse[paste0('to_bet_', data_min_adverse$better_favourite[1], '_if_', data_min_adverse$better_favourite[1], '_favourite')])[1], 2)

player_to_bet_for <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_favourite[1])])[1]
player_to_bet_for_nationality <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_favourite[1], '_nationality')])[1]
player_to_bet_for_atp_ranking <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_favourite[1], '_rank')])[1]
best_bet_bookmaker <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_favourite[1], '_bookmaker')])[1]
best_bet_bookmaker_link <- bookmakers_df %>% filter(bookmakers==pull(data_min_adverse[paste0('player_', data_min_adverse$better_favourite[1], '_bookmaker')])[1]) %>% select(bookmakers_links)
best_bet_betting_odds <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_favourite[1], '_odds')])[1]

value_to_bet2 <- round(pull(data_min_adverse[paste0('to_bet_', data_min_adverse$better_non_favourite[1], '_if_', data_min_adverse$better_favourite[1], '_favourite')])[1], 2)
player_to_bet_for2 <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_non_favourite[1])])[1]
player_to_bet_for_nationality2 <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_non_favourite[1], '_nationality')])[1] 
player_to_bet_for_atp_ranking2 <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_non_favourite[1], '_rank')])[1]
best_bet_bookmaker2 <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_non_favourite[1], '_bookmaker')])[1]
best_bet_bookmaker_link2 <- bookmakers_df %>% filter(bookmakers==pull(data_min_adverse[paste0('player_', data_min_adverse$better_non_favourite[1], '_bookmaker')])[1]) %>% select(bookmakers_links)
best_bet_betting_odds2 <- pull(data_min_adverse[paste0('player_', data_min_adverse$better_non_favourite[1], '_odds')])[1]

expected_return_pln <- round(pull(data_min_adverse[paste0('win_', data_min_adverse$better_non_favourite[1], '_bet_', data_min_adverse$better_favourite[1])])[1], 2)
expected_return_percentage <- round(100*pull(data_min_adverse[paste0('win_', data_min_adverse$better_non_favourite[1], '_bet_', data_min_adverse$better_favourite[1], '_return')])[1], 2)

event <- pull(data_min_adverse['event'])[1]
match_time <- pull(data_min_adverse['match_time'])[1]

```


## Best bet prediction
### Best bet in case the favourite wins

Having `r money` PLN, the best bet to do right now in order to have `r 100*expected_return`% return in the case of a favorite win and minimal loss in the case of the favorite loss is to bet `r value_to_bet` PLN on `r player_to_bet_for` (`r player_to_bet_for_nationality`, ATP ranking: `r player_to_bet_for_atp_ranking`) on [`r best_bet_bookmaker`](`r best_bet_bookmaker_link`) (betting odds: `r best_bet_betting_odds`) and `r value_to_bet2` PLN on `r player_to_bet_for2` (`r player_to_bet_for_nationality2`, ATP ranking: `r player_to_bet_for_atp_ranking2`) on [`r best_bet_bookmaker2`](`r best_bet_bookmaker_link2`) (betting odds: `r best_bet_betting_odds2`, expected return: `r expected_return_pln` PLN, that is `r expected_return_percentage`%) in `r event` (starting `r match_time`).


```{r variables2, echo=FALSE,include=FALSE}
# List of variable for inline referencing

value_to_bet_ <- round(pull(data_max_return[paste0('to_bet_', data_max_return$better_non_favourite[1], '_if_', data_max_return$better_favourite[1], '_favourite')])[1], 2)

player_to_bet_for_ <- pull(data_max_return[paste0('player_', data_max_return$better_non_favourite[1])])[1]
player_to_bet_for_nationality_ <- pull(data_max_return[paste0('player_', data_max_return$better_non_favourite[1], '_nationality')])[1]
player_to_bet_for_atp_ranking_ <- pull(data_max_return[paste0('player_', data_max_return$better_non_favourite[1], '_rank')])[1]
best_bet_bookmaker_ <- pull(data_max_return[paste0('player_', data_max_return$better_non_favourite[1], '_bookmaker')])[1]
best_bet_bookmaker_link_ <- bookmakers_df %>% filter(bookmakers==pull(data_max_return[paste0('player_', data_max_return$better_non_favourite[1], '_bookmaker')])[1]) %>% select(bookmakers_links)
best_bet_betting_odds_ <- pull(data_max_return[paste0('player_', data_max_return$better_non_favourite[1], '_odds')])[1]

value_to_bet2_ <- round(pull(data_max_return[paste0('to_bet_', data_max_return$better_favourite[1], '_if_', data_max_return$better_favourite[1], '_favourite')])[1], 2)
player_to_bet_for2_ <- pull(data_max_return[paste0('player_', data_max_return$better_favourite[1])])[1]
player_to_bet_for_nationality2_ <- pull(data_max_return[paste0('player_', data_max_return$better_favourite[1], '_nationality')])[1]
player_to_bet_for_atp_ranking2_ <- pull(data_max_return[paste0('player_', data_max_return$better_favourite[1], '_rank')])[1]
best_bet_bookmaker2_ <- pull(data_max_return[paste0('player_', data_max_return$better_favourite[1], '_bookmaker')])[1]
best_bet_bookmaker_link2_ <- bookmakers_df %>% filter(bookmakers==pull(data_max_return[paste0('player_', data_max_return$better_favourite[1], '_bookmaker')])[1]) %>% select(bookmakers_links)
best_bet_betting_odds2_ <- pull(data_max_return[paste0('player_', data_max_return$better_favourite[1], '_odds')])[1]

expected_return_pln_ <- round(pull(data_max_return[paste0('win_', data_max_return$better_favourite[1], '_bet_', data_max_return$better_favourite[1])])[1], 2)
expected_return_percentage_ <- round(100*pull(data_max_return[paste0('win_', data_max_return$better_favourite[1], '_bet_', data_max_return$better_favourite[1], '_return')])[1], 2)

event_ <- pull(data_max_return['event'])[1]
match_time_ <- pull(data_max_return['match_time'])[1]


```

### Best bet in case the favourite loses
Having `r money` PLN, the best bet to do right now in order to have maximum`r 100*adverse_return`% return in the case of a favorite loss and maximal return in the case of the favorite win is to bet `r value_to_bet_`PLN on `r player_to_bet_for_` (`r player_to_bet_for_nationality_`, ATP ranking: `r player_to_bet_for_atp_ranking_`) on [`r best_bet_bookmaker_`](`r best_bet_bookmaker_link_`) (betting odds: `r best_bet_betting_odds_`, expected return: `r expected_return_pln` PLN, that is `r expected_return_percentage_`%) and `r value_to_bet2_` PLN on `r player_to_bet_for2_` (`r player_to_bet_for_nationality2_`, ATP ranking: `r player_to_bet_for_atp_ranking2_`) on [`r best_bet_bookmaker2_`](`r best_bet_bookmaker_link2_`) (betting odds: `r best_bet_betting_odds2_`) in `r event_` (starting `r match_time_`)

```{r variables_top3_for_each_bookmaker, echo=FALSE,include=FALSE}
# List of variable for inline referencing

# ===========
# eFortuna
# Min_adverse
# ========
#Player
data_b1.1 <- data_min_adverse %>% filter(player_1_bookmaker == "eFortuna" | player_2_bookmaker == "eFortuna")
data_b1.1_player_1 <- pull(data_b1.1[paste0('player_', data_b1.1$better_favourite[1])])[1]
data_b1.1_player_2 <- pull(data_b1.1[paste0('player_', data_b1.1$better_favourite[2])])[2]
data_b1.1_player_3 <- pull(data_b1.1[paste0('player_', data_b1.1$better_favourite[3])])[3]

# Event
data_b1.1_event_1 <- pull(data_b1.1['event'])[1]
data_b1.1_event_2 <- pull(data_b1.1['event'])[2]
data_b1.1_event_3 <- pull(data_b1.1['event'])[3]

# Time
data_b1.1_time_1 <- pull(data_max_return['match_time'])[1]
data_b1.1_time_2 <- pull(data_max_return['match_time'])[2]
data_b1.1_time_3 <- pull(data_max_return['match_time'])[3]

# Money to bet
data_b1.1_money_1 <- round(pull(data_b1.1[paste0('to_bet_', data_b1.1$better_favourite[1], '_if_', data_b1.1$better_favourite[1], '_favourite')])[1], 2)
data_b1.1_money_2 <- round(pull(data_b1.1[paste0('to_bet_', data_b1.1$better_favourite[2], '_if_', data_b1.1$better_favourite[1], '_favourite')])[2], 2)
data_b1.1_money_3 <- round(pull(data_b1.1[paste0('to_bet_', data_b1.1$better_favourite[3], '_if_', data_b1.1$better_favourite[1], '_favourite')])[3], 2)

# Expected return
data_b1.1_return_1 <- round(pull(data_b1.1[paste0('win_', data_b1.1$better_non_favourite[1], '_bet_', data_b1.1$better_favourite[1])])[1], 2)
data_b1.1_return_2 <- round(pull(data_b1.1[paste0('win_', data_b1.1$better_non_favourite[2], '_bet_', data_b1.1$better_favourite[2])])[2], 2)
data_b1.1_return_3 <- round(pull(data_b1.1[paste0('win_', data_b1.1$better_non_favourite[3], '_bet_', data_b1.1$better_favourite[3])])[3], 2)

# ===========
# eFortuna
# Max return
# ========

data_b1.2 <- data_max_return %>% filter(player_1_bookmaker == "eFortuna" | player_2_bookmaker == "eFortuna")

# Player
data_b1.2_player_1 <- pull(data_b1.2[paste0('player_', data_b1.2$better_non_favourite[1])])[1]
data_b1.2_player_2 <- pull(data_b1.2[paste0('player_', data_b1.2$better_non_favourite[2])])[2]
data_b1.2_player_3 <- pull(data_b1.2[paste0('player_', data_b1.2$better_non_favourite[3])])[3]

# Event
data_b1.2_event_1 <- pull(data_b1.2['event'])[1]
data_b1.2_event_2 <- pull(data_b1.2['event'])[2]
data_b1.2_event_3 <- pull(data_b1.2['event'])[3]
    
# Time
data_b1.2_time_1 <- pull(data_max_return['match_time'])[1]
data_b1.2_time_2 <- pull(data_max_return['match_time'])[2]
data_b1.2_time_3 <- pull(data_max_return['match_time'])[3]

# Money to bet
data_b1.2_money_1 <- round(pull(data_b1.2[paste0('to_bet_', data_b1.2$better_non_favourite[1], '_if_', data_b1.2$better_favourite[1], '_favourite')])[1], 2)
data_b1.2_money_2 <- round(pull(data_b1.2[paste0('to_bet_', data_b1.2$better_non_favourite[2], '_if_', data_b1.2$better_favourite[1], '_favourite')])[2], 2)
data_b1.2_money_3 <- round(pull(data_b1.2[paste0('to_bet_', data_b1.2$better_non_favourite[3], '_if_', data_b1.2$better_favourite[1], '_favourite')])[3], 2)

# Expected return
data_b1.2_return_1 <- round(pull(data_b1.2[paste0('win_', data_b1.2$better_favourite[1], '_bet_', data_b1.2$better_favourite[1])])[1], 2)
data_b1.2_return_2 <- round(pull(data_b1.2[paste0('win_', data_b1.2$better_favourite[2], '_bet_', data_b1.2$better_favourite[2])])[2], 2)
data_b1.2_return_3 <- round(pull(data_b1.2[paste0('win_', data_b1.2$better_favourite[3], '_bet_', data_b1.2$better_favourite[3])])[3], 2)



```

### Top 3 bets for each bookmaker
**eFortuna**

*Minimum adverse*

1. Bet `r data_b1.1_money_1` PLLN for `r data_b1.1_player_1` in `r data_b1.1_event_1` (starting `r data_b1.1_time_1`) with an expected return of `r data_b1.1_return_1`

2. Bet `r data_b1.1_money_2` PLLN for `r data_b1.1_player_2` in `r data_b1.1_event_2` (starting `r data_b1.1_time_2`) with an expected return of `r data_b1.1_return_2`

3. Bet `r data_b1.1_money_3` PLLN for `r data_b1.1_player_3` in `r data_b1.1_event_3` (starting `r data_b1.1_time_3`) with an expected return of `r data_b1.1_return_3`

*Maximum return*

1. Bet `r data_b1.2_money_1` PLLN for `r data_b1.2_player_1` in `r data_b1.2_event_1` (starting `r data_b1.2_time_1`) with an expected return of `r data_b1.2_return_1`

2. Bet `r data_b1.2_money_2` PLLN for `r data_b1.2_player_2` in `r data_b1.2_event_2` (starting `r data_b1.2_time_2`) with an expected return of `r data_b1.2_return_2`

3. Bet `r data_b1.2_money_3` PLLN for `r data_b1.2_player_3` in `r data_b1.2_event_3` (starting `r data_b1.2_time_3`) with an expected return of `r data_b1.2_return_3`


**Disclaimer**

*Please note, that online betting is a gambling entertainment vehicle, and that it carries with it a certain degree of financial risk. Players should be aware of this risk, and govern themselves accordingly.*
